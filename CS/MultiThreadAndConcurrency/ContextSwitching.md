# 컨텍스트 스위칭

- 멀티태스킹은 반드시 효율적인 것은 아니다

## 컴퓨터의 멀티태스킹

- 스레드 A,B,C의 멀티태스킹을 가정한다면,
  - 스레드 A,B,C가 순차적으로 실행된다
  - 스레드 A이후 B가 실행되고, 다시 A가 실행되기 위해서는 스레드A가 사용하던 값들을 메모리에 저장해두고 다시 실행할때 이를 꺼내서 사용해야한다
  - 이렇게 사용에 필요한 context를 가져와서 switching 하는 과정을 컨텍스트 스위칭이라고 한다
  - 결국 이런 과정에는 비용이 발생하게 된다
  - 즉, 멀티스레드는 대부분 효율적이지만 컨텍스트 스위칭 과정이 필요하므로 항상 효율적인 것은 아니다

## 효율적인 컨텍스트 스위칭 예시

- 1~10000까지 더하는 경우의 예시
  - 스레드1: 1~5000까지 더함
  - 스레드2: 5001~10000까지 더함
  - 마지막에 스레드1과 스레드2를 더함

### CPU 코어가 2개인 경우

- 스레드1, 스레드2로 나누어 병렬처리하는게 효율적이다.
- 모든 CPU를 사용하므로 연산을 2배 빠르게 처리할 수 있다

### CPU 코어가 1개인 경우

- 코어가 1개인데 스레드를 2개로 만들어서 연산하면 컨텍스트 스위칭 비용이 발생한다
- 운영체제 스케줄링 방식에 따라서 다르겠지만, 스레드1을 1-1000까지 연산한 상태에서 멈추고 스레드2를 5001-6000까지 연산하는 식으로 반복한다
  - 이때 CPU는 스레드1을 멈추고 다시 실행할 때 어디까지 연산했는지 알아야하고, 그 값을 CPU에 다시 불러와야 한다
  - 결과적으로 반복할 때 마다 컨텍스트 스위칭 비용이 든다
  - 이 경우 단일 스레드로 1-10000까지 더하는 것이 컨텍스트 스위칭 비용 없이 연산 시간만 사용하기 때문에 더 효율적이다
  - 실제로 최신 CPU는 초당 수십억 단위를 계산하기에 실제로는 계산에 더 큰 숫자를 사용해야 컨텍스트 스위칭이 발생한다

## 실무 예시

### CPU 4개, 스레드 2개

- 스레드의 숫자가 너무 적으면 모든 CPU를 100% 활용 불가능하지만, 스레드가 몇 개 없으므로 컨텍스트 스위칭 비용이 줄어든다

### CPU 4개, 스레드 100개

- 스레드의 숫자가 너무 많으면 CPU를 100%다 활용할 수 있지만, 컨텍스트 스위칭 비용이 늘어난다

### CPU 4개, 스레드 4개

- 스레드의 숫자를 CPU의 숫자에 맞춘다면 CPU를 100% 활용할 수 있고, 컨텍스트 스위칭 비용도 자주 발생하지 않기 때문에 최적의 상태가 된다
- 이상적으로는 CPU 코어 수 + 1개 정도로 스레드를 맞추면 특정 스레드가 잠시 대기할 때 남은 스레드를 활용할 수 있다

## CPU 바운드 작업 vs I/O 바운드 작업

- 스레드의 역할은 2가지가 있다
  1. CPU-바운드 작업
  - CPU 연산 능력을 많이 요구하는 작업
  - 이러한 작업은 주로 계산, 데이터 처리, 알고리즘 실행 등 CPU의 처리 속도가 작업 완료 시간을 결정하는 경우
  - ex) 복잡한 수학 연산, 데이터 분석, 비디오 인코딩, 과학적 시뮬레이션 등
  2. I/O 바운드 작업
  - 디스크, 네트워크, 파일 시스템 같은 IO/O 작업을 의미한다
  - 이러한 작업은 IO작업이 완료 될 때까지 대기 시간이 많이 발생하며, CPU는 상대적으로 대기상태에 있는 경우가 많다
  - CPU를 사용하지 않고 IO 작업이 완료될 때까지 대기하는 경우이다
  - ex) db 쿼리 처리, 파일 읽기/쓰기, 네트워크 통신, 사용자 입력 처리 등

## 그래서 웹 개발자의 경우..

- 웹 개발자의 실무는 cpu바운드 보다는 I/O바운드 작업이 많다
- 사용자의 요청을 하나 처리하는데 스레드는 CPU의 1%정도를 사용하고, 대부분 데이터 베이스 서버에서 결과를 조회하면서 기다린다
- 스레드는 CPU를 거의 사용하지 않고 대기한다
- 그래서 웹 개발의 경우 코어가 4개 있다고해서 스레드도 4개로 설정하면 안된다
    - 이 경우 사용자는 동시에 4명밖에 못받으며, CPU가 놀고 있는 사태가 벌어진다
- 사용자의 요청 하나를 처리하는데 CPU의 1%만 사용한다면, 단순하게 생각해도 100개의 스레드를 만들 수 있다
    - 이러면 100개의 요청을 동시에 받을 수 있으며, 실제는 성능 테스트를 통해 최적의 스레드 숫자를 찾아야한다
- 결국 스레드의 숫자를 늘리면 되는데 이런 부분을 이해 못해서 서버 장비에 문제가 있다고 생각하고 2배 더 좋은 장비로 구매하는 사태가 발생하기도 한다
    - 이렇게 되면 4% CPU의 절반인 2%만 사용하고 여전히 4명만 받는 사태가 벌어진다

## Recap

- CPU 바운드 작업: CPU 코어 수 + 1개
    - CPU를 100% 사용하므로 스레드를 CPU 숫자에 최적화
- IO 바운드 작업: CPU코어 수 보다 많은 스레드를 생성, CPU를 최대한 사용할 수 있는 숫자까지 스레드 생성
    - CPU를 많이 사용하지 않으므로, 성능 테스트를 통해 CPU를 최대한 활용하는 숫자까지 스레드 생성
    - 너무 많은 스레드 사용시 컨텍스트 스위칭 비용도 증가, 성능테스트 필요
- 아무리 웹 어플리케이션 서버라도 CPU 바운드 작업이 많을 수 있으므로, 최적화된 숫자를 찾는 것이 중요하다